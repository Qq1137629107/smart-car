C51 COMPILER V9.60.0.0   NRF24L01                                                          12/29/2022 11:03:33 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE NRF24L01
OBJECT MODULE PLACED IN .\Objects\nrf24l01.obj
COMPILER INVOKED BY: D:\APP\Keil\C51\BIN\C51.EXE nrf24l01.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings
                    -\nrf24l01.lst) TABS(2) OBJECT(.\Objects\nrf24l01.obj)

line level    source

   1          #include "commom.h"
   2          
   3          u8 SelfAddr[TX_ADR_WIDTH] = {0x01, 0x01, 0x01, 0x01, 0x01};       //本机硬件地址
   4          
   5          
   6          
   7          /*********************************************************************************************************
             -*****************/
   8          /*=========================================================私有函数===================================
             -====================*/
   9          /*********************************************************************************************************
             -*****************/
  10          
  11          /*-----------------------------------------------------------------------------
  12          函数名称：SPI_RW
  13          输入参数：byte：待发送的一个字节数据
  14          返回数据：收到的一个字节数据
  15          功能描述：模拟SPI接口通讯收发一体化函数
  16          ------------------------------------------------------------------------------*/
  17          u8 SPI_RW(u8 byte){
  18   1        u8 i;
  19   1        for(i=0; i<8; i++)
  20   1        {
  21   2          if(byte & 0x80)
  22   2            MOSI = 1;
  23   2          else
  24   2            MOSI = 0;
  25   2          byte = (byte << 1);
  26   2          SCK1 = 1;
  27   2          byte |= MISO;
  28   2          SCK1 = 0;
  29   2        }
  30   1        return byte;
  31   1      }
  32          
  33          /*-----------------------------------------------------------------------------
  34          函数名称：nRF24L01P_Write_Reg
  35          输入参数：reg：寄存器映射地址（格式：WRITE_REG｜reg）；value：待写的寄存器值
  36          功能描述：写状态寄存器的值
  37          ------------------------------------------------------------------------------*/
  38          void nRF24L01P_Write_Reg(u8 reg, u8 value){
  39   1        CSN = 0;
  40   1        SPI_RW(reg);
  41   1        SPI_RW(value);
  42   1        CSN = 1;
  43   1      }
  44          
  45          /*-----------------------------------------------------------------------------
  46          函数名称：nRF24L01P_Write_Buf
  47          输入参数：reg：寄存器映射地址（格式：WRITE_REG｜reg）；pBuf：待写数据首地址；
             -bytes：写数据字节数
  48          功能描述：写状态寄存器的值
  49          ------------------------------------------------------------------------------*/
  50          void nRF24L01P_Write_Buf(u8 reg, const u8 *pBuf, u8 bytes){
C51 COMPILER V9.60.0.0   NRF24L01                                                          12/29/2022 11:03:33 PAGE 2   

  51   1        u8 i;
  52   1      
  53   1        CSN = 0;                                        
  54   1        SPI_RW(reg);                          
  55   1        for(i=0; i<bytes; i++)     
  56   1          SPI_RW(*pBuf++);
  57   1        CSN = 1;     
  58   1      }                            
  59          
  60          /*-----------------------------------------------------------------------------
  61          函数名称：nRF24L01P_Read_Reg
  62          输入参数：reg：寄存器映射地址（格式：READ_REG｜reg）
  63          返回数据：寄存器值
  64          功能描述：读状态寄存器的值（单字节）
  65          ------------------------------------------------------------------------------*/
  66          u8 nRF24L01P_Read_Reg(u8 reg){
  67   1        u8 value;
  68   1      
  69   1        CSN = 0;    
  70   1        SPI_RW(reg);      
  71   1        value = SPI_RW(0);
  72   1        CSN = 1;              
  73   1      
  74   1        return(value);
  75   1      }
  76          
  77          /*-----------------------------------------------------------------------------
  78          函数名称：nRF24L01P_Read_Reg
  79          输入参数：reg：寄存器映射地址（格式：READ_REG｜reg）；pBuf：接收缓冲区的首地
             -；bytes：读取字节数
  80          功能描述：读状态寄存器的值（多字节）
  81          ------------------------------------------------------------------------------*/
  82          void nRF24L01P_Read_Buf(u8 reg, u8 *pBuf, u8 bytes){
  83   1        u8 i;
  84   1      
  85   1        CSN = 0;                                        
  86   1        SPI_RW(reg);                           
  87   1        for(i=0; i<bytes; i++)
  88   1          pBuf[i] = SPI_RW(0);                                    //读取数据，低字节在前
  89   1        CSN = 1;   
  90   1      }
  91          
  92          
  93          /*********************************************************************************************************
             -*****************/
  94          /*=========================================================公有函数===================================
             -====================*/
  95          /*********************************************************************************************************
             -*****************/
  96          
  97          /*-----------------------------------------------------------------------------
  98          函数名称：RF24_RfSetup
  99          输入参数：ch：射频工作频道
 100          功能描述：nRF24L01P+工作频道设置
 101          ------------------------------------------------------------------------------*/
 102          void RF24_SetRfCh(u8 ch){
 103   1        CE = 0;
 104   1        nRF24L01P_Write_Reg(WR_RF_CH, ch);                          //设置变更射频通道
 105   1        CE = 1;
 106   1      }
 107          
 108          /*-----------------------------------------------------------------------------
C51 COMPILER V9.60.0.0   NRF24L01                                                          12/29/2022 11:03:33 PAGE 3   

 109          函数名称：RF24_Init
 110          功能描述：nRF24L01P+初始化
 111          ------------------------------------------------------------------------------*/
 112          void RF24_Init(){
 113   1        SCK = 0;                                  //SPI时钟线拉低
 114   1        CSN = 1;                                  //片选脚拉高处于未选状态
 115   1        CE  = 0;                                  //拉低使能配置，收发时要拉高
 116   1        IRQ = 1;                                  //中断引脚抬高处于未触发中断状态
 117   1      
 118   1        CE = 0;
 119   1        nRF24L01P_Write_Reg(WR_SETUP_AW, 0x03);                           //设置地址宽度为5字节
 120   1        nRF24L01P_Write_Reg(WR_RF_SETUP, RFSETUP);                    //数据传输率、发射功率配置为公共变
             -RfSetup的值
 121   1        nRF24L01P_Write_Reg(WR_EN_AA, 0x01);                            //使能接收通道0自动应答
 122   1        nRF24L01P_Write_Reg(WR_EN_RXADDR, 0x01);                    //使能接收通道0
 123   1        nRF24L01P_Write_Reg(WR_RX_PW_P0, TX_PLOAD_WIDTH);               //接收通道0选择和发送通道相同有
             -数据宽度，仅接收有效
 124   1        nRF24L01P_Write_Reg(WR_SETUP_RETR, RETE_VAL);               //自动重发时间间隔和重发次数，仅发
             -有效
 125   1        CE = 1;
 126   1      }
 127          
 128          /*-----------------------------------------------------------------------------
 129          函数名称：RF24_RX_Mode
 130          功能描述：nRF24L01P+设置为接收模式
 131          ------------------------------------------------------------------------------*/
 132          void RF24_RX_Mode()
 133          {
 134   1        CE = 0;
 135   1        nRF24L01P_Write_Buf(WR_RX_ADDR_P0, SelfAddr, TX_ADR_WIDTH);         //接收设备接收通道0使用和发
             -设备相同的发送地址
 136   1        nRF24L01P_Write_Reg(WR_CONFIG, 0x0F);                           //CRC使能，16位CRC校验，开机，接收
             -式
 137   1        nRF24L01P_Write_Reg(WR_STATUS, 0xFF);                     //清除所有的中断标志位
 138   1        CE = 1;                                                         //拉高CE启动接收设备
 139   1      }           
 140          
 141          /*-----------------------------------------------------------------------------
 142          函数名称：RF24_TX_Mode
 143          输入参数：*toAddr：发送目标地址指针
 144          功能描述：nRF24L01P+设置为发送模式
 145          ------------------------------------------------------------------------------*/
 146          void RF24_TX_Mode(u8 *toAddr)
 147          {
 148   1        CE = 0;
 149   1        nRF24L01P_Write_Buf(WR_TX_ADDR, toAddr, TX_ADR_WIDTH);            //写入发送地址
 150   1        nRF24L01P_Write_Reg(WR_CONFIG, 0x0E);                       //CRC使能，16位CRC校验，开机，发送模式
             -屏蔽自动重发中断
 151   1        nRF24L01P_Write_Buf(WR_RX_ADDR_P0, toAddr, TX_ADR_WIDTH);         //为了应答接收设备，接收通道0
             -址和发送地址相同
 152   1        nRF24L01P_Write_Reg(WR_STATUS, 0xFF);                     //清除所有的中断标志位
 153   1        //CE = 1;
 154   1      }
 155          
 156          /*-----------------------------------------------------------------------------
 157          函数名称：RF24_RxData
 158          输入参数：*rxbuf：保存接收数据的缓冲区指针
 159          返回数据：是否收到数据，1收到，0未收到
 160          功能描述：nRF24L01P+判断是否收到数据，若收到直接取出，应在主循环中调用
 161          ------------------------------------------------------------------------------*/
 162          bit RF24_RxData(u8 *rxbuf)
 163          {
C51 COMPILER V9.60.0.0   NRF24L01                                                          12/29/2022 11:03:33 PAGE 4   

 164   1        u8 state;
 165   1      
 166   1        if(IRQ == 0)                                //有中断触发，判断中断可以提高CPU效率，减少SPI通讯量
 167   1        {
 168   2          state = nRF24L01P_Read_Reg(STATUS);                   //读取状态寄存器的值       
 169   2          nRF24L01P_Write_Reg(WR_STATUS, state);                  //清除RX_DS中断标志
 170   2          if(state & RX_DR)                           //接收到数据
 171   2          {
 172   3            nRF24L01P_Read_Buf(RD_RX_PLOAD,rxbuf,TX_PLOAD_WIDTH);       //读取数据
 173   3            nRF24L01P_Write_Reg(FLUSH_RX,0xFF);                 //清除RX FIFO寄存器
 174   3            return ON; 
 175   3          }
 176   2        }    
 177   1        return OFF;                                 //没收到任何数据
 178   1      }
 179          
 180          /*-----------------------------------------------------------------------------
 181          函数名称：RF24_TxData
 182          输入参数：*txbuf：待发送数据的缓冲区指针
 183          返回数据：是否发送成功，1发送成功，0发送失败
 184          功能描述：nRF24L01P+发送数据
 185          ------------------------------------------------------------------------------*/
 186          bit RF24_TxData(u8 *txbuf)
 187          {
 188   1        u8 state;
 189   1        
 190   1        while(RPD == 1);
 191   1        CE=0;                                   //CE拉低，使能24L01配置
 192   1        nRF24L01P_Write_Buf(WR_TX_PLOAD,txbuf,TX_PLOAD_WIDTH);            //写数据到TX FIFO,32个字节
 193   1        CE=1;                                   //CE置高，使能发送    
 194   1      
 195   1        while(IRQ == 1);                              //等待发送完成
 196   1        state=nRF24L01P_Read_Reg(STATUS);                       //读取状态寄存器的值    
 197   1        nRF24L01P_Write_Reg(WR_STATUS, state);                    //清除TX_DS或MAX_RT中断标志
 198   1        if(state&TX_DS)                               //发送完成
 199   1          return ON;
 200   1        nRF24L01P_Write_Reg(FLUSH_TX,0xff);                     //清除TX FIFO寄存器 
 201   1        return OFF;                                 //发送失败
 202   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    371    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      5      13
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
